<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>待打印普通发票(连打)</title>
<script type="text/javascript" src="../js/jquery/jquery-1.11.1.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
<script src="../bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../My97DatePicker/WdatePicker.js"></script>
<!--[if lt IE 9]>
         <script src="../js/html5shiv.js"></script>
         <script src="../js/respond.min.js"></script>
      <![endif]-->
      
<link rel="stylesheet" type="text/css" href="../js/page/pageGroup.css"/>
<script type="text/javascript" src="../js/page/pageGroup.js"></script>      
<style type="text/css">
th,td{width: 120px; height: 35px;text-align:center;}
</style>

<script type="text/javascript">
var pageCount = 1;
var skconf = null;
var printconf = null;
var fphmlist = null;
function chaxun(){
	var params = $('#queryForm').serialize();
	$.ajax({
		type:"GET",
        url: "../printpps/printlist",
        data: params,
        async: false,
        success: function (data) {
        	//alert(JSON.stringify(data))
        	pageCount = data.pageCount;
    		var cc = $('#requestPage').val()-1;
        	if(pageCount>5){
        		page_icon(1,5,cc);
        	}else{
        		page_icon(1,pageCount,cc);
        	}	
        		$("#printBody").children().remove();
        		if(data.list.length>0){
    				var tbo = '';
        			for(var i=0;i<data.list.length;i++){
        				var size = data.list[i].endfphm - data.list[i].beginfphm + 1;
        				tbo = tbo + '<tr>'
       						+'<td class="">' + data.list[i].beginDate + '</td>'
       						+'<td>' + data.list[i].endDate + '</td>'
       						+'<td>' + data.list[i].beginfphm + '</td>'
       						+'<td>' + data.list[i].endfphm + '</td>'
       						+'<td>普通发票</td>'
       						+'<td>' + size + '</td>'
       						
       						//+'<td>'+'<input type="button" id="dayin" value="打印" onclick="dayin(' + data[i].fpqqlsh + ')">' + '</td>'
       						+'<td style="width: 200px;">' + '<a href="javascript:" onclick="chakan(' + data.list[i].beginfphm + ',' + data.list[i].endfphm + ');">查看详情</a>' 
       						+ '&nbsp;&nbsp;&nbsp;&nbsp;'
       						+ '<a href="javascript:" onclick="dayin(' + data.list[i].beginfphm + ',' + data.list[i].endfphm + ');">连续打印</a>' 
       						+ '</td>'
       						
       						+'</tr>';
        			}
        			//alert(tbo)
        			$("#printBody").html(tbo);
        			/* $('.invitetable1 tr:odd').css('background','#fffceb');
        			parent.dyniframesize('openli');  */
        		}else{
        			//alert(0)
        		}
        	
        },
        error:function(XMLHttpRequest, textStatus, errorThrown) {
        	if(XMLHttpRequest.responseText=="timeOut"){
        		window.top.location.reload();
        	}else{
        		alert("Error");
        	}
        }
	});
	
}

function chakan(begin, end){
	location.href='./showDetails.html?begin=' + begin + '&end=' + end + '&fplx=007';
}

function dayin(beginfphm, endfphm){
	fphmlist = null;
	getParameter(beginfphm, endfphm);
	if(!SetParameter()){
		return;
	}
	for(var i=0;i<fphmlist.length;i++){
		var fpqqlsh = fphmlist[i].fpqqlsh;
		var fpdm = fphmlist[i].fpdm;
		var fphm = fphmlist[i].fphm;
		PrintInvoice(fpqqlsh,fpdm, fphm);
	}
}

function getParameter(beginfphm, endfphm){
	var params = {'fplx' : '004',"beginfphm": beginfphm, "endfphm": endfphm};
	$.ajax({
		type:"GET",
        url: "../prints/getParameters",
        data: params,
        async: false,
        success: function (data) {
        	//alert(JSON.stringify(data))
        	if(data.code == '-1'){
        		window.top.location.href="../login/login.html";
        	}else{
        		skconf = data.skconf;
        		printconf = data.printconf;
        		fphmlist = data.list;
        	}
        },
        error:function(XMLHttpRequest, textStatus, errorThrown) {
        	if(XMLHttpRequest.responseText=="timeOut"){
        		window.top.location.reload();
        	}else{
        		alert("Error");
        	}
        }
	});
}

//发票打印
function SetParameter() {
	if(skconf == null){
		alert("初始化参数失败");
		return false;
	}
	//01设置初始化参数
	var sInputInfo = "<?xml version=\"1.0\" encoding=\"gbk\"?>\r\n<business id=\"20001\" comment=\"参数设置\">\r\n<body yylxdm=\"1\">\r\n<servletip>" + skconf.url + "</servletip>\r\n<servletport>"+ skconf.port +"</servletport>\r\n<keypwd>00000000</keypwd>\r\n<aqm>50543ed18fc81784d9a17a18e10a9d68e7e4c4303568c14e3aa1280f87006578b59ca8d492921c725a1199f9c7fc9ba21c8f15d953fb673a5612a52e813c2ade0ebcf42c7d7e0a1fe15a8655a2919176bd3801d3be36654e4fffe8fb38ae4c02498b43de96c00e23765a204fbd16752c9514ffef10467646892f32ad3a146d3ea9928c8a622aa349bfdbd2b49eae3f7e852be50df3c0532447c99abfded4b5c07871cef1ebbf1a9986df508f4fe9f452eb44b6a220df76a90830a0e35c4483c6f85edb5590858fe9685d45895c5c1a16ea689db99ba1f4d4103902dab1972f8a6f7bb2ba1f84fa37c76d238016cc40e4ef08025b3e226c48e43adb1c0daf2d8b</aqm>\r\n</body>\r\n</business>";		
	try {
		ret = sk.Operate(sInputInfo);
		/* var pos=ret.indexOf("<returncode>"); */
		var returncode = getTotalMidValue(ret, "<returncode>","</returncode>");
		var returnmsg = getTotalMidValue(ret, "<returnmsg>","</returnmsg>");	
		if(returncode==0&&returnmsg=="成功"){
			alert("参数设置成功！");	
			return true;
		}else{
			alert("参数设置失败，失败原因："+returnmsg);
			return false;
		}
	} catch (e) {
		alert(e.message + ",errno:" + e.number);
		return false;
	}
}

function PrintInvoice(fpqqlsh,fpdm, fphm){	
	//01页边距设置
	//var sInputInfo = "<?xml version=\"1.0\" encoding=\"gbk\"?><business id=\"20004\"comment=\"鍙戠エ鎵撳嵃\"><body yylxdm=\"1\"><kpzdbs>12345612346</kpzdbs><fplxdm>007</fplxdm><fpdm>1110000452</fpdm><fphm>38148009</fphm><dylx>0</dylx><dyfs>0</dyfs></body></business>";
	var sMarginsInfo = " <?xml version=\"1.0\" encoding=\"gbk\"?>\r\n<business id=\"20003\" comment=\"页边距设置\">\r\n<body yylxdm=\"1\">\r\n<fplxdm>007</fplxdm>\r\n<top>" + printconf.topside + "</top>\r\n<left>" + printconf.leftside + "</left>\r\n</body>\r\n</business>";		
	sMargret = sk.Operate(sMarginsInfo);
	var returncodesMarg = getTotalMidValue(sMargret, "<returncode>","</returncode>");
	var returnmsgsMarg = getTotalMidValue(sMargret, "<returnmsg>","</returnmsg>");	
	if(returncodesMarg==0&&returnmsgsMarg=="成功"){
		//02、打印发票
		var sPrintInfo = "<?xml version=\"1.0\" encoding=\"gbk\"?><business id=\"20004\"comment=\"发票打印\"><body yylxdm=\"1\"><kpzdbs>0601</kpzdbs><fplxdm>007</fplxdm><fpdm>"+fpdm+"</fpdm><fphm>"+ fphm+"</fphm><dylx>0</dylx><dyfs>0</dyfs></body></business>";
		alert(sPrintInfo);
		sPrintInret = sk.Operate(sPrintInfo);
		var returncodesPrintIn = getTotalMidValue(sPrintInret, "<returncode>","</returncode>");
		var returnmsgsPrintIn = getTotalMidValue(sPrintInret, "<returnmsg>","</returnmsg>");
		if(returncodesPrintIn==0&&returnmsgsPrintIn=="成功"){
			//alert("打印成功！");
			savePrintResult(fpqqlsh,3)
		}else{
			alert("打印失败，失败原因："+returnmsgsPrintIn);
		}
	}else{
		    alert("页面距设置失败，失败原因："+returnmsgsMarg);
	}		
		
}

function savePrintResult(fpqqlsh,fpzt){
	var params = {'fpqqlsh': fpqqlsh,'fpzt' : fpzt};
	$.ajax({
		type:"GET",
        url: "../print/savePrintResult",
        data: params,
        async: false,
        success: function (data) {
        	//alert(JSON.stringify(data))
        	if(data.code == '1'){
        		alert("打印成功！");
        	}else{
        		alert("打印成功,保存失败");
        	}
        },
        error:function(XMLHttpRequest, textStatus, errorThrown) {
        	if(XMLHttpRequest.responseText=="timeOut"){
        		window.top.location.reload();
        	}else{
        		alert("Error");
        	}
        }
	});
}

//获取指定的字符串
function getTotalMidValue(source, priStr, suxStr) {
	if (source == null)
		return null;
	var iFirst = source.indexOf(priStr);		
	var iLast = source.lastIndexOf(suxStr);		
	if (iFirst < 0 || iLast < 0)
		return null;	
	var beginIndex = iFirst + priStr.length;	
	return source.substring(beginIndex, iLast);
}

</script>
</head>
<body>
<h4>查询条件</h4>
<form id="queryForm" name='queryForm' class="form-horizontal" role="form">
	<div class="form-inline form-group">
		<div class="form-group col-sm-5">
	      <label for="beginDate" class="col-sm-3 control-label">开票起止日期：</label>
	      <div class="col-sm-3">
	         <input type="text" class="form-control" id="beginDate" name="beginDate" placeholder="起始时间" value=""
	         	onfocus="var endDate=$dp.$('endDate');WdatePicker({dateFmt:'yyyy-MM-dd',readOnly:true,onpicked:function(){endDate.focus();},maxDate:'#F{$dp.$D(\'endDate\')}'})">
	      </div>
	      <div class="col-sm-3">
	         <input type="text" class="form-control" id="endDate" name="endDate" placeholder="结束时间" value=""
	         	onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',readOnly:true,minDate:'#F{$dp.$D(\'beginDate\')}'})">
	      </div>
	   </div>
	   <div class="form-group col-sm-5">
	      <label for="fphm" class="col-sm-3 control-label">发票起止号码：</label>
	      <div class="col-sm-3">
	         <input type="text" class="form-control" id="beginfphm" name="beginfphm" placeholder="起始号码" value="">
	      </div>
	      <div class="col-sm-3">
	         <input type="text" class="form-control" id="endfphm" name="endfphm" placeholder="结束号码" value="">
	         <input type="hidden" id='fplx' name='fplx' value='007'>
	         <input type="hidden" id='requestPage' name='requestPage' value='1'><!-- 请求页数 -->
	         <input type="hidden" id='pageSize' name='pageSize' value='2'><!-- 每页行数 -->
	      </div>
	   </div>
	</div>
	
	<div class="form-inline form-group">
		
	   <div class="form-group col-sm-5">
	      <div class="col-sm-offset-2 col-sm-10">
	         <button type="button" class="btn btn-default" onclick="chaxun();">查询</button>
	      </div>
	   </div>
	</div>
</form>

<hr>

<table border="1" cellspacing="0" >
<thead>
	<th>开票日期起</th>
	<th>开票日期止</th>
	<th>发票号码起</th>
	<th>发票号码止</th>
	<th>发票种类</th>
	<th>连续张数</th>
	<th>操作</th>
</thead>
<tr>
<tbody id="printBody">

</tbody>

</table>

<div id="pageGro" class="cb">
	<div class="pageUp">上一页</div>
    <div class="pageList">
        <ul>
            <li>1</li>
            <li>2</li>
            <li>3</li>
            <li>4</li>
            <li>5</li>
        </ul>
    </div>
    <div class="pageDown">下一页</div>
</div>

</body>
</html>