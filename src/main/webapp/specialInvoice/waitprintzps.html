<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>待打印专用发票(连打)</title>
<OBJECT ID=sk CLASSID="clsid:003BD8F2-A6C3-48EF-9B72-ECFD8FC4D49F"
	codebase="NISEC_SKSCX.ocx#version=1,0,0,1" style="display: none;"> </OBJECT>
<script type="text/javascript" src="../My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../js/jquery/jquery-1.11.1.js"></script>
<script type="text/javascript" src="../js/jquery/jquery.easyui.min.js"></script>
<link rel="stylesheet" type="text/css" href="../css/easyui.css"/>
<script type="text/javascript" src="../js/jquery/easyui-lang-zh_CN.js"></script>
<link rel="stylesheet" type="text/css" href="../css/easyui_global.css"/>

<script type="text/javascript">
var skconf = null;
var printconf = null;
var fphmlist = null;


function getParameter(beginfphm, endfphm){
	var params = {'fplx' : '004',"beginfphm": beginfphm, "endfphm": endfphm};
	$.ajax({
		type:"POST",
        url: "../prints/getParameters",
        data: params,
        async: false,
        success: function (data) {
        	//alert(JSON.stringify(data))
        	if(data.code == '-1'){
        		window.top.location.href="../login/login.html";
        	}else{
        		skconf = data.skconf;
        		printconf = data.printconf;
        		fphmlist = data.list;
        	}
        },
        error:function(XMLHttpRequest, textStatus, errorThrown) {
        	if(XMLHttpRequest.responseText=="timeOut"){
        		window.top.location.reload();
        	}else{
        		alert("Error");
        	}
        }
	});
}

//发票打印
function SetParameter() {
	if(skconf == null){
		alert("初始化参数失败");
		return false;
	}
	//01设置初始化参数
	//var sInputInfo = "<?xml version=\"1.0\" encoding=\"gbk\"?>\r\n<business id=\"20001\" comment=\"参数设置\">\r\n<body yylxdm=\"1\">\r\n<servletip>192.168.6.14</servletip>\r\n<servletport>1008</servletport>\r\n<keypwd>123456</keypwd>\r\n<aqm>8a3e00af8a8197e4b81dc694d607ca22c587d4edf9caf387b17a49ed1ff9077607e2c6b3860422db744cf1ff1c4844957dc10cb9a5951d45d773ac564cc9f51bc1f767dd26b9ef5f8723d921ed1db14bb5c3ff90c9a801485718bd3a1032dd54c60d1137d4e3bf144ed69d990307f623f6894a7c51a60fbbe1ea8e60d2216a5b03dcef0de6ef11bdb905e9e315eb0b8edfb0d0e37b72f8619ae9171f8091d2cd802bf504d1fcf6bf1a652b559bfc505368b7160de2854508d821fa3450e5dc1e846511e163c057fd003645388eddd7be077bcb39a8bc744816b52581862a641bb0e699cde6a803c494695f0d20b7b9593978ae9b649dd0b10b87d7bbb2a04891</aqm>\r\n</body>\r\n</business>";		
	var sInputInfo = "<?xml version=\"1.0\" encoding=\"gbk\"?>\r\n<business id=\"20001\" comment=\"参数设置\">\r\n<body yylxdm=\"1\">\r\n<servletip>" + skconf.url + "</servletip>\r\n<servletport>"+ skconf.port +"</servletport>\r\n<keypwd>123456</keypwd>\r\n<aqm>8a3e00af8a8197e4b81dc694d607ca22c587d4edf9caf387b17a49ed1ff9077607e2c6b3860422db744cf1ff1c4844957dc10cb9a5951d45d773ac564cc9f51bc1f767dd26b9ef5f8723d921ed1db14bb5c3ff90c9a801485718bd3a1032dd54c60d1137d4e3bf144ed69d990307f623f6894a7c51a60fbbe1ea8e60d2216a5b03dcef0de6ef11bdb905e9e315eb0b8edfb0d0e37b72f8619ae9171f8091d2cd802bf504d1fcf6bf1a652b559bfc505368b7160de2854508d821fa3450e5dc1e846511e163c057fd003645388eddd7be077bcb39a8bc744816b52581862a641bb0e699cde6a803c494695f0d20b7b9593978ae9b649dd0b10b87d7bbb2a04891</aqm>\r\n</body>\r\n</business>";		
	
	try {
		ret = sk.Operate(sInputInfo);
		/* var pos=ret.indexOf("<returncode>"); */
		var returncode = getTotalMidValue(ret, "<returncode>","</returncode>");
		var returnmsg = getTotalMidValue(ret, "<returnmsg>","</returnmsg>");	
		if(returncode==0&&returnmsg=="成功"){
			//alert("参数设置成功！");	
			return true;
		}else{
			alert("参数设置失败，失败原因："+returnmsg);
			return false;
		}
	} catch (e) {
		alert(e.message + ",errno:" + e.number);
		return false;
	}
}

function SetPrintLocation(){
	//01页边距设置
	var sMarginsInfo = " <?xml version=\"1.0\" encoding=\"gbk\"?>\r\n<business id=\"20003\" comment=\"页边距设置\">\r\n<body yylxdm=\"1\">\r\n<fplxdm>004</fplxdm>\r\n<top>" + printconf.topside + "</top>\r\n<left>" + printconf.leftside + "</left>\r\n</body>\r\n</business>";		
	
	sMargret = sk.Operate(sMarginsInfo);
	var returncodesMarg = getTotalMidValue(sMargret, "<returncode>","</returncode>");
	var returnmsgsMarg = getTotalMidValue(sMargret, "<returnmsg>","</returnmsg>");	
	if(returncodesMarg==0&&returnmsgsMarg=="成功"){
		return true;
	}else{
	    alert("页面距设置失败，失败原因："+returnmsgsMarg);
	    return false;
	}	
		
}

function PrintInvoice(fpqqlsh,fpdm, fphm){	
	
		//02、打印发票
		var sPrintInfo = "<?xml version=\"1.0\" encoding=\"gbk\"?><business id=\"20004\"comment=\"发票打印\"><body yylxdm=\"1\"><kpzdbs>0601</kpzdbs><fplxdm>004</fplxdm><fpdm>"+fpdm+"</fpdm><fphm>"+ fphm+"</fphm><dylx>0</dylx><dyfs>1</dyfs></body></business>";
		//alert(sPrintInfo);
		sPrintInret = sk.Operate(sPrintInfo);
		var returncodesPrintIn = getTotalMidValue(sPrintInret, "<returncode>","</returncode>");
		var returnmsgsPrintIn = getTotalMidValue(sPrintInret, "<returnmsg>","</returnmsg>");
		if(returncodesPrintIn==0&&returnmsgsPrintIn=="成功"){
			//alert("打印成功！");
			savePrintResult(fpqqlsh,3);
			return true;
		}else{
			alert("打印失败，失败原因："+returnmsgsPrintIn);
			return false;
		}
			
		
}

function savePrintResult(fpqqlsh,fpzt){
	var params = {'fpqqlsh': fpqqlsh,'fpzt' : fpzt};
	$.ajax({
		type:"POST",
        url: "../print/savePrintResult",
        data: params,
        async: false,
        success: function (data) {
        	//alert(JSON.stringify(data))
        	if(data == '1'){
        		//alert("打印成功！");
        		searchZpList();
        	}else{
        		alert("打印成功,保存失败");
        	}
        },
        error:function(XMLHttpRequest, textStatus, errorThrown) {
        	if(XMLHttpRequest.responseText=="timeOut"){
        		window.top.location.reload();
        	}else{
        		alert("Error");
        	}
        }
	});
}

//获取指定的字符串
function getTotalMidValue(source, priStr, suxStr) {
	if (source == null)
		return null;
	var iFirst = source.indexOf(priStr);		
	var iLast = source.lastIndexOf(suxStr);		
	if (iFirst < 0 || iLast < 0)
		return null;	
	var beginIndex = iFirst + priStr.length;	
	return source.substring(beginIndex, iLast);
}

</script>
</head>
<body>

<div id="toolbar_div" class="toolbar_div" >
   <a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-print" onclick="print();" plain="true">打印</a>
   <a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-redo" onclick="showDetail();" plain="true">查看详情</a>
   <a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-search" onclick="hideOrShow();" plain="true">查询</a>
   
   <div id="div_search" class="div_search">
		<form id='queryForm' action="">
			<div class="" style="line-height: 30px;">
				<label>开票起止日期:</label>
				<input type="text" class="form-control" id="beginDate" name="beginDate" placeholder="开始时间" value=""
	         	onfocus="var endDate=$dp.$('endDate');WdatePicker({dateFmt:'yyyy-MM-dd',readOnly:true,onpicked:function(){endDate.focus();},maxDate:'#F{$dp.$D(\'endDate\')}'})">
	         	<label>-</label>
	         	<input type="text" class="form-control" id="endDate" name="endDate" placeholder="结束时间" value=""
	         	onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',readOnly:true,minDate:'#F{$dp.$D(\'beginDate\')}'})">
				
				<label>发票起止号码:</label>
				<input type="text" class="form-control" id="beginfphm" name="beginfphm" placeholder="开始号码" value="">
				<label>-</label>
		     	<input type="text" class="form-control" id="endfphm" name="endfphm" placeholder="结束号码" value="">
				<input type="hidden" id='fplx' name='fplx' value='004'>
				
				<a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-search" onclick="searchZpList();" plain="true">查找</a>
				
			</div>
		</form>
   </div>
</div>

<table id="datagrid_zp"></table>

<script type="text/javascript">
initDataGridComponent();
var datagrid_zp;
function initDataGridComponent(){
	var qParams = form2Json('queryForm');
	
	datagrid_zp = $("#datagrid_zp").datagrid({
				title : "待打印专用发票列表(连打)",
				singleSelect:true,
				rownumbers:true,
				width:'100%',
				height:'500',
				idField:'id',
				url:"../printpps/printlist",
				pagination : true,
				pageSize : 50,
				pageNumber:1,
				pageList: [10,20,50,100],
				queryParams: qParams,
				columns:[[
				     /* {field:'id',title:'id',width:100,checkbox:true}, */
		             {field:'beginDate',title:'开票日期起',width:100,editor:'text'},
		             {field:'endDate',title:'开票日期止',width:100,editor:'text'},
		             {field:'beginfphm',title:'发票号码起',width:100,editor:'text'},
		             {field:'endfphm',title:'发票号码止',width:100,editor:'text'},
			         {field:'lxzs',title:'连续张数',width:100,editor:'text'}
				]],
				onClickRow:function(index){	
					
				}
	});
	
}


/**
 * 显示或隐藏
 */
function hideOrShow(){
	$("#div_search").toggle();
}

/**
 * 打印
 */
function print(){
	var row = datagrid_zp.datagrid('getSelected');
	
	if(row ==null || row == ''){
		alert('请选择一项进行打印!');
		return;
	}
	/* alert(row.beginfphm + ',' + row.endfphm) */
	if(confirm("确定要打印么？")){
		fphmlist = null;
		getParameter(row.beginfphm, row.endfphm);
		if(!SetParameter()){
			return;
		}
		if(!SetPrintLocation()){
			return;
		}
		for(var i=0;i<fphmlist.length;i++){
			var fpqqlsh = fphmlist[i].fpqqlsh;
			var fpdm = fphmlist[i].fpdm;
			var fphm = fphmlist[i].fphm;
			var isfalse = PrintInvoice(fpqqlsh,fpdm, fphm);
			if(!isfalse){
				return;
			}
		}
	}
}

function showDetail(){
	var row = datagrid_zp.datagrid('getSelected');
	
	if(row ==null || row == ''){
		alert('请选择一项!');
		return;
	}
	/* alert(row.beginfphm + ',' + row.endfphm) */
	
	location.href='../regularInvoice/showDetails.html?begin=' + row.beginfphm + '&end=' + row.endfphm + '&fplx=004';
}
/**
 * 查询
 */
function searchZpList(){
	var qParams = form2Json('queryForm');
	$("#datagrid_zp").datagrid("load", qParams);
}

//将表单数据转为json
function form2Json(id) {

    var arr = $("#" + id).serializeArray()
    var jsonStr = "";

    jsonStr += '{';
    for (var i = 0; i < arr.length; i++) {
        jsonStr += '"' + arr[i].name + '":"' + arr[i].value + '",'
    }
    jsonStr = jsonStr.substring(0, (jsonStr.length - 1));
    jsonStr += '}'

    var json = JSON.parse(jsonStr)
    return json
}


$(function(){
	
})
</script>


</body>
</html>